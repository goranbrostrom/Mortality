---
title: "Sampling deaths and OLS"
author: "Göran Broström"
date: "January 19, 2018"
output:
  bookdown::html_document2:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
  bookdown::pdf_document2:
    citation_package: natbib
    number_sections: yes
    toc: no
    toc_depth: 2
    keep_tex: true

---


# Introduction

We check the effect of studying mortality of the dead and whether it is reasonable to assume normally distributed remaining life after age 60.

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(engine='R',fig.path='figs/ols-',tidy=FALSE,fig.height=4,fig.width=8,strip.white=TRUE,cache=FALSE,echo=FALSE,message=FALSE,comment=NA,show.signif.stars = FALSE)##$
library(knitr)
library(eha)
library(xtable)
library(skum)
options(show.signif.stars = FALSE)
```

# Data

Data come from Skellefteå and Umeå. The selection is all persons born between January 1, 1841 and December 31, 1850 and present in 
the data at age 60.
They are followed from age 60 to death or right censoring (at most until December 31, 1950). 


```{r readalldata}
##source("R/get.file.R")
##skume <- get.file("skume")
## Not needed(?):
##vb0Tab <- skume
##vb0Tab$civst <- relevel(vb0Tab$civst, ref = "married")
##vb0Tab <- aggregate(vb0Tab[, c("event", "exposure")],
##                    vb0Tab[, c("sex", "age", "period", "cohort", "civst", "hisclass", "urban")],
##                    FUN = sum)
## End: Not needed(?)
ols <- obs[, c("id", "sex", "birthdate", "region", "civst", "sluttyp", "enter", "exit")]
ols$event <- ols$sluttyp == 2
ols$sluttyp <- NULL
ols <- ols[ols$birthdate >= 1841 & ols$birthdate < 1851, ]
ols <- age.window(ols, c(60, 100))
ids <- ols$id[ols$enter < 60.01]
ols <- ols[ols$id %in% ids, ]
indx <- tapply(ols$id, ols$id)
out <- tapply(ols$exit, ols$id, max)
ols$out <- out[indx]
ols <- ols[order(ols$id, -ols$exit, -ols$event),]
##sum(ols$event)
ols <- ols[!duplicated(ols$id), ]
##sum(ols$event)
ols$exit <- ols$out
ols$out <- NULL
summary(ols)
```

We want to observe time since age 60 (exact!), so we subtract 60 from the ages `enter` and `exit`.

```{r}
ols$enter <- ols$enter - 60
ols$exit <- ols$exit - 60
zero <- ols$enter >= ols$exit
ols$enter[zero] <- ols$exit[zero] - 0.001 # Fix zero-length intervals (no big deal)
```

In the following, we are interested in the *sex difference* in expected remaining life after 60 (*e60*) (just as an illustration). The categorical variable `region` is included as an example of a confounder.

# Survival analysis with OLS

## Full data

*OLS* means assuming *normally distributed* remaining life after 60, and we can use standard linear regression. In the case of right censoring, we need to fall back on maximum likelihood for the estimation. The function *survreg* in the **R** package **survival** facilitates this.

```{r survrcens}
fit <- survreg(Surv(exit, event) ~ sex + region, data = ols, dist = "gaussian")
x <- summary(fit)
x
```

So the *e60* for men from Skellefteå is `r round(x$coef[1], 2)` years and for women it is `r round(x$coef[2], 2)` more years.

## Sampling the dead

We repeat the analyses with the data subset consisting of all those who were observerd to die in the parishes. This implies that 13 percent censored individuals are thrown away.

```{r smallols, echo = FALSE}
ids <- ols$id[ols$event == 1]
sols <- ols[ols$id %in% ids, ]
```

```{r survrnocens}
fit2 <- survreg(Surv(exit, event) ~ sex + region, data = sols, dist = "gaussian")
x2 <- summary(fit2)
x2
```

So the *e60* for men from Skellefteå is now `r round(x2$coef[1], 2)` years and for women it is `r round(x2$coef[2], 2)` more years.

## Conclusion

Sampling of deaths leads to overestimation of mortality (underestimation of *e60*): This is a trivial (well-known) consequence. More seriously, it distorts the balance between categories (`sex`, `region`) in unpredictable ways.


# AFT regression

The OLS model is an example of what is called  an *accelerated failure time (AFT)* model in survival analysis, a competitor to the *proportional hazards (PH)* model. 
A common assumption about old age mortality is that a *Gompertz* distribution fits well.

So we go back to the full data situation and fit a Gompertz AFT model. The *survreg* function does not include the Gompertz distribution, but the *aftreg* function in the package **eha** does.

```{r aft, echo = FALSE}
fit.g <- aftreg(Surv(exit, event) ~ sex, data = ols, dist = "gompertz", param = "lifeExp")
summary(fit.g)
```


```{r plotln}
plot(fit.g, fn = "haz", xlab = "Years after 60.")
```


```{r standards}
fit <- coxph(Surv(enter, exit, event) ~ strata(region, sex), data = ols)
plot(survfit(fit), fun = "cumhaz", col = 1:4, lty = 1:4, xlab = "Years after 60.", ylab = "Cumulative hazards", xlim = c(0, 30))
legend("topleft", legend = levels(strata(ols$region, ols$sex)), col = 1:4, lty = 1:4)
abline(h = 0)
```

It seems as if males have the same mortality experience in Umeå and Skellefteå, while women from Umeå are better off than those from Skellefteå. Of course, women are much better off than men, reardless of region. So, there is a tendency of *interaction* between the effects on mortality of `sex` and `region`.

We cannot easily calculate *e60* from this figure (or table above), but the estimated median remaining life at 60 (*m60*) is easy to illustrate graphically. For that porpose we need to plot the estimated *survival functions*.
```{r }
plot(survfit(fit), col = 1:4, lty = 1:4, xlab = "Years after 60.", 
     ylab = "Remaining fraction", xlim = c(0, 30), axes = FALSE)
axis(1, at = c(0, 9, 13, 20, 30))
axis(2, at = c(0, 0.5, 1), las = 1)
box()
legend("bottomleft", legend = levels(strata(ols$region, ols$sex)), col = 1:4, lty = 1:4)
abline(h = 0)
abline(h = 0.5, lty = 2)
```

We can also make an exact calculation, which results in

```{r exactki}
x <- survfit(fit)
x
```

## AFT regression

Then an *accelerated failure time (AFT)* model ("linear regression on the log scale, with censoring").

```{r afts}
fit <- aftreg(Surv(enter, exit, event) ~ sex + region, data = ols, dist = "lognormal", param = "lifeExp")
meanlog <- fit$coefficients["log(scale)"]
sdlog <- 1 / exp(fit$coefficients["log(shape)"])
fit$baselineMean <- exp(meanlog + sdlog^2 / 2)
summary(fit)
```

The *e60* for men in Skellefteå is 9.69, and for Skellefteå women it is $1.329 \times 9.69 = 12.88$, a difference of 3.19 years.

The lognormal baseline plot looks like this:

```{r plotlns}
plot(fit, fn = "haz", xlab = "Years after 60.")
```

Not very convincing: The mortality is *decreasing* after age 70 (forced by the lognormal assumption)!

We try the *Gompertz* distribution instead:

```{r aftgomps}
fit.g <- aftreg(Surv(enter, exit, event) ~ sex + region, data = ols, dist = "gompertz", param = "lifeExp")

summary(fit.g)
```

The *e60* for men in Skellefteå is now 11.2, and for Skellefteå women it is $1.075 \times 11.2 = 12.04$, a difference of only 0.84 years.

The Gompertz baseline plot looks like this:

```{r plotgomps}
plot(fit.g, fn = "haz", xlab = "Years after 60.")
```

A lot more reasonable.
